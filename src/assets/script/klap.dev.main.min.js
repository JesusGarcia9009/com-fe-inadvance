var KLAP;void 0===KLAP&&(KLAP={}),KLAP.init=function(config){KLAP.version="1.1.0",console.log("KLAP.version: "+KLAP.version);const JQUERY_VERSION="3.3.1",CARD_METHOD="tarjetas",SODEXO_METHOD="sodexo",CHECKOUT_KLAP_ID="#checkout-klap",DATA_KLAP_ORDER_ID="data-klap-order-id",DATA_KLAP_CARD_NUMBER="data-klap-card-number",DATA_KLAP_EXPIRY_DATE="data-klap-expiry-date",DATA_KLAP_CARD_CVV="data-klap-card-cvv",DATA_KLAP_GENERATE_TOKEN="data-klap-generate-token",DATA_KLAP_FN_SUCCESS="data-klap-fn-success",DATA_KLAP_FN_ERROR="data-klap-fn-error",DATA_KLAP_FN_RETRY="data-klap-fn-retry",DATA_KLAP_SODEXO_RUT="data-klap-sodexo-rut",DATA_KLAP_SODEXO_EMAIL="data-klap-sodexo-email",DATA_KLAP_SODEXO_CARD_TYPE="data-klap-sodexo-card-type",DATA_KLAP_SODEXO_CODE="data-klap-sodexo-code",DATA_KLAP_CARD_TYPE="data-klap-card-type",DATA_KLAP_QUOTAS="data-klap-quotas";let paying=!1,jQueryObject,jwk,sjwt,sessionId,ipAddress,errors=[];const klapConfig={prodMode:!0,method:CARD_METHOD,debug:!1,successUrl:null,errorUrl:null},DEBIT_VALUE=1,CREDIT_VALUE=2,URL="https://pagos-pasarela-verticaldesa.mcdesaqa.cl",URL_FLEX=URL+"/js/flex-sdk-web.min.js",URL_UTILS=URL+"/js/utils.js",URL_SONGBIRD="https://songbirdstag.cardinalcommerce.com/cardinalcruise/v1/songbird.js",URL_SONGBIRD_PROD="https://songbird.cardinalcommerce.com/edge/v1/songbird.js",URL_FINGERPRINT="https://h.online-metrix.net/fp/tags.js?org_id=##orgId##&session_id=##merchantId####sessionId##",URL_IPIFY="https://api.ipify.org";function addJQueryScript(){const e=createElement("script",[{name:"type",value:"text/javascript"},{name:"src",value:`${URL}/javascripts/jquery-${JQUERY_VERSION}.min.js`}]);e.onload=scriptLoadHandler,e.onreadystatechange=function(){"complete"!==this.readyState&&"loaded"!==this.readyState||scriptLoadHandler(!0)},(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(e)}function scriptLoadHandler(e){jQueryObject=e?window.jQuery.noConflict(!1):window.jQuery,jQueryObject.getScript(URL_UTILS),klapConfig.method===CARD_METHOD&&(jQueryObject.getScript(URL_FLEX),klapConfig.prodMode?jQueryObject.getScript(URL_SONGBIRD_PROD):jQueryObject.getScript(URL_SONGBIRD)),jQueryObject(document).ready(function(){loadCheckoutKlap()})}function loadCheckoutKlap(){const e=document.querySelector(CHECKOUT_KLAP_ID);if(isCheckoutKlapValid(e))if(klapConfig.method===CARD_METHOD){const t=e.getAttribute(DATA_KLAP_ORDER_ID);jQueryObject.ajax({url:URL_IPIFY,type:"GET",success:function(e){ipAddress=e},error:function(e){klapConfig.prodMode||console.log("An error occurred while obtained the ip address, err:",JSON.stringify(e)),ipAddress=""}});var r={url:`${URL}/cards/frictionless/${t}`,type:"GET",dataType:"json",scriptCharset:"utf-8",async:!0,headers:{"Content-Type":"application/json",Accept:"application/json"},success:function(e){klapConfig.prodMode||console.log("Loading Card frictionless: ",JSON.stringify(e));var r,o=e.order;"pending"===e.status?(r=URL_FINGERPRINT.replace("##orgId##",o.orgId).replace("##merchantId##",o.merchantId).replace("##sessionId##",o.sessionId),jQueryObject.getScript(r),jwk=JSON.parse(o.keyInfo),sjwt=JSON.parse(o.songbirdJwt),sessionId=o.sessionId,KLAP.payOrder=payOrder):(klapConfig.prodMode||console.log(`Order ${t} is not in pending status. order.status: ${e.status}.`),notifyError(ERROR.E400001))},error:function(e){klapConfig.prodMode||console.log("Error getting card order: "+JSON.stringify(e)),notifyError(e)}};jQueryObject.ajax(r)}else KLAP.payOrder=payOrder}function payOrder(){if(paying)klapConfig.prodMode||console.log("The order has been paying or was paid.");else switch(klapConfig.method){case CARD_METHOD:return void payCardOrder();case SODEXO_METHOD:return void paySodexoOrder();default:return klapConfig.prodMode||console.log(`Payment method (${klapConfig.method}) is not supported yet.`),void notifyError(ERROR.E400014)}}function payCardOrder(){var e=getOnlyNumbersByDataAttribute(DATA_KLAP_CARD_NUMBER);const r=getOnlyNumbersByDataAttribute(DATA_KLAP_EXPIRY_DATE);var o=getValueByDataAttribute(DATA_KLAP_CARD_CVV),t=+document.querySelector(`${CHECKOUT_KLAP_ID} [${DATA_KLAP_CARD_TYPE}]`).getAttribute(DATA_KLAP_CARD_TYPE),n=t===DEBIT_VALUE?0:getValueByDataAttribute(DATA_KLAP_QUOTAS);isValidForPayCardOrder(e,r,o,t,n)&&(paying=!0,o={kid:jwk.kid,keystore:jwk,cardInfo:{cardNumber:e,cardType:getBrand(e),cvn:o,expiryMonth:r.slice(0,2),expiryYear:"20"+r.slice(2,4)},encryptionType:"rsaoaep256"},klapConfig.prodMode||console.log("Creating FLEX token: ",JSON.stringify(o)),FLEX.createToken(o,responseHandler))}function paySodexoOrder(){var e=document.querySelector(CHECKOUT_KLAP_ID).getAttribute(DATA_KLAP_ORDER_ID),r=getValueByDataAttribute(DATA_KLAP_SODEXO_RUT),o=getValueByDataAttribute(DATA_KLAP_SODEXO_EMAIL),t=getValueByDataAttribute(DATA_KLAP_SODEXO_CARD_TYPE),n=getValueByDataAttribute(DATA_KLAP_SODEXO_CODE);isValidForPaySodexoOrder(e,r,o,t,n)&&(paying=!0,n={orderId:e,rut:r,email:o,cardType:t,code:n},n={url:URL+"/sodexo/frictionless/receipt",type:"POST",scriptCharset:"utf-8",async:!0,data:n,headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},success:function(e){if(!klapConfig.prodMode&&klapConfig.debug&&console.log("Receipt responseData: ",JSON.stringify(e)),400014===e.code)return paying=!1,void notifyRetry(e);"SUCCESS"!==e.code?e.code&&e.message?notifyError({code:e.code,message:e.message}):notifyError(ERROR.E500006):notifySuccess(e.data)},error:function(e){klapConfig.prodMode||console.log("Error initiating payment: ",JSON.stringify(e)),notifyError(ERROR.E500002)}},jQueryObject.ajax(n))}function isValidForPaySodexoOrder(e,r,o,t,n){if(isBlank(e)&&errors.push(ERROR.E404004),isBlank(r)||isRut(r)||errors.push(ERROR.E400010),isBlank(o)||isEmail(o)||errors.push(ERROR.E400011),isBlank(t)||isSodexoCardType(t)||errors.push(ERROR.E400012),isBlank(n)||(n=n.match(/\d/gi))&&4!==n.length&&errors.push(ERROR.E400013),!(0<errors.length))return 1;notifyError(errors)}function responseHandler(e){if(e.error)return klapConfig.prodMode||console.log("Error creating the flex token. "+JSON.stringify(e.error)),void notifyError(ERROR.E500001);initSongbird(e)}function initSongbird(n){klapConfig.prodMode||console.log("Songbird flexResponse: ",JSON.stringify(n)),Cardinal.configure({logging:{level:klapConfig.prodMode?"off":"verbose"}}),Cardinal.on("payments.setupComplete",function(e){klapConfig.prodMode||console.log("setupCompleteData: ",JSON.stringify(e));const r=getOnlyNumbersByDataAttribute(DATA_KLAP_EXPIRY_DATE);var o=null!==document.querySelector(`${CHECKOUT_KLAP_ID} [${DATA_KLAP_GENERATE_TOKEN}]:checked`),t=+document.querySelector(`${CHECKOUT_KLAP_ID} [${DATA_KLAP_CARD_TYPE}]`).getAttribute(DATA_KLAP_CARD_TYPE)===DEBIT_VALUE?0:+document.querySelector(`${CHECKOUT_KLAP_ID} [${DATA_KLAP_QUOTAS}]`).value,o={sSessionId:e.sessionId,flexResponse:JSON.stringify(n),expirationMonth:r.slice(0,2),expirationYear:r.slice(2,4),ipAddress:ipAddress,sessionId:sessionId,orderId:document.querySelector(CHECKOUT_KLAP_ID).getAttribute(DATA_KLAP_ORDER_ID),quota:t,generateToken:o};klapConfig.prodMode||console.log("Calling to /cards/receipt: ",JSON.stringify(o));o={url:URL+"/cards/receipt",type:"POST",scriptCharset:"utf-8",async:!0,data:o,headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},success:function(e){var r;!klapConfig.prodMode&&klapConfig.debug&&console.log("Receipt responseData: ",JSON.stringify(e)),"SEND_TO_CHALLENGE"!==e.status?"SUCCESS"!==e.status?notifyError(ERROR.E500003):notifySuccess(e):(r={AcsUrl:`${e.data.acsUrl}`,Payload:`${e.data.pareq}`},e={OrderDetails:{TransactionId:`${e.data.authenticationTransactionId}`}},Cardinal.continue("cca",r,e))},error:function(e){klapConfig.prodMode||console.log("Error initiating payment: "+JSON.stringify(e)),notifyError(ERROR.E500002)}};jQueryObject.ajax(o)}),Cardinal.on("payments.validated",function(e,r){!klapConfig.prodMode&&klapConfig.debug&&console.log("Payments.validated: \njwt: "+JSON.stringify(r)+"\ndata: "+JSON.stringify(e));r={url:URL+"/cards/frictionless/validate",type:"POST",scriptCharset:"utf-8",async:!0,data:{jwt:r},headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},success:function(e){klapConfig.prodMode||console.log("Validate after Challenge responseData: ",JSON.stringify(e)),"SUCCESS"!==e.status?notifyError(ERROR.E500005):notifySuccess(e)},error:function(e){klapConfig.prodMode||console.log("Error at payments.validated event: "+JSON.stringify(e)),notifyError(ERROR.E500004)}};jQueryObject.ajax(r)}),Cardinal.setup("init",{jwt:sjwt,order:{Consumer:{Account:{AccountNumber:`${n.maskedPan.substr(0,6)}`}}}})}function isCheckoutKlapValid(e){if(null!=e){if(!isValidUrl(klapConfig.errorUrl)){const r=document.querySelector(`${CHECKOUT_KLAP_ID}[${DATA_KLAP_FN_ERROR}]`);if(null===r||isBlank(r.getAttribute(DATA_KLAP_FN_ERROR)))return void console.log("%cCritical error: "+JSON.stringify(ERROR.E404003),"color: #fc0202")}if(!isValidUrl(klapConfig.successUrl)){const o=document.querySelector(`${CHECKOUT_KLAP_ID}[${DATA_KLAP_FN_SUCCESS}]`);null!==o&&!isBlank(o.getAttribute(DATA_KLAP_FN_SUCCESS))||errors.push(ERROR.E404002)}if(null===document.querySelector(`${CHECKOUT_KLAP_ID}[${DATA_KLAP_ORDER_ID}]`)&&errors.push(ERROR.E404004),klapConfig.method===CARD_METHOD?validateCardCheckout():klapConfig.method!==SODEXO_METHOD&&errors.push(ERROR.E400014),!(0<errors.length))return 1;notifyError(errors)}else console.log("%cCritical error: "+JSON.stringify(ERROR.E404001),"color: #fc0202")}function validateCardCheckout(){null===document.querySelector(`${CHECKOUT_KLAP_ID} [${DATA_KLAP_CARD_NUMBER}]`)&&errors.push(ERROR.E404005),null===document.querySelector(`${CHECKOUT_KLAP_ID} [${DATA_KLAP_EXPIRY_DATE}]`)&&errors.push(ERROR.E404006),null===document.querySelector(`${CHECKOUT_KLAP_ID} [${DATA_KLAP_CARD_CVV}]`)&&errors.push(ERROR.E404007),null===document.querySelector(`${CHECKOUT_KLAP_ID} [${DATA_KLAP_CARD_TYPE}]`)&&errors.push(ERROR.E404901);var e=document.querySelector(`${CHECKOUT_KLAP_ID} [${DATA_KLAP_CARD_TYPE}]`).getAttribute(DATA_KLAP_CARD_TYPE);+e!==DEBIT_VALUE&&+e!==CREDIT_VALUE&&errors.push(ERROR.E400901),+e===CREDIT_VALUE&&null===document.querySelector(`${CHECKOUT_KLAP_ID} [${DATA_KLAP_QUOTAS}]`)&&errors.push(ERROR.E404902)}function isValidForPayCardOrder(e,r,o,t,n){if(e?16!==e.length?errors.push(ERROR.E400005):isValidCardNumber(e)||errors.push(ERROR.E400009):errors.push(ERROR.E400002),r?4!==r.length&&errors.push(ERROR.E400006):errors.push(ERROR.E400003),o?3!==o.length&&errors.push(ERROR.E400007):errors.push(ERROR.E400004),t?t!==DEBIT_VALUE&&t!==CREDIT_VALUE&&errors.push(ERROR.E400901):errors.push(ERROR.E404901),(null==n||t===CREDIT_VALUE&&n<1||48<n||t===DEBIT_VALUE&&0!==n)&&errors.push(ERROR.E400008),!(0<errors.length))return 1;notifyError(errors)}function isValidCardNumber(t){if(t){var e=null!=t.match(new RegExp("^4")),n=null!=t.match(new RegExp("^5[1-5]"));if(e||n){var n=t.length,a=n%2;let o=0;for(let r=n-1;0<=r;r--){let e=parseInt(t.charAt(r));r%2==a&&(e*=2),9<e&&(e-=9),o+=e}return o%10==0}}}function createElement(e,r){const o=document.createElement(e);for(let e=0;e<r.length;e++)o.setAttribute(r[e].name,r[e].value);return o}function getOnlyNumbersByDataAttribute(e){const r=getValueByDataAttribute(e);if(void 0===r||null===r)return null;const o=r.match(/\d/gi);return o?o.join(""):null}function getValueByDataAttribute(e){e=document.querySelector(`${CHECKOUT_KLAP_ID} [${e}]`);return e?e.value:null}function loadConfig(e){null!=e&&(void 0!==e.prod&&null!==e.prod&&(klapConfig.prodMode="false"!==String(e.prod).toLowerCase()&&Boolean(e.prod)),void 0!==e.debug&&null!==e.debug&&(klapConfig.debug="false"!==String(e.debug).toLowerCase()&&Boolean(e.debug)),klapConfig.successUrl=isValidUrl(e.successUrl)?e.successUrl:null,klapConfig.errorUrl=isValidUrl(e.errorUrl)?e.errorUrl:null,e.method&&[CARD_METHOD,SODEXO_METHOD].includes(e.method)&&(klapConfig.method=e.method))}function notifyError(err){if(klapConfig.errorUrl)return klapConfig.prodMode||console.log("NotifyError: errorUrl",klapConfig.errorUrl),void(window.location=klapConfig.errorUrl);jQueryObject.isArray(err)||(err=[err]);const callback_error=document.querySelector(`${CHECKOUT_KLAP_ID}[${DATA_KLAP_FN_ERROR}]`).getAttribute(DATA_KLAP_FN_ERROR),callback_error_function=eval(callback_error);"function"==typeof callback_error_function?callback_error_function(err):(console.log(`It was impossible to report the errors, ${callback_error} is not a function.`),console.log(`Errors: ${JSON.stringify(errors)}`)),errors=[]}function notifySuccess(data){if(klapConfig.successUrl)return klapConfig.prodMode||console.log("NotifyError: successUrl",klapConfig.successUrl),void(window.location=klapConfig.successUrl);const callback_success=document.querySelector(`${CHECKOUT_KLAP_ID}[${DATA_KLAP_FN_SUCCESS}]`).getAttribute(DATA_KLAP_FN_SUCCESS),callback_success_function=eval(callback_success);"function"==typeof callback_success_function?callback_success_function(data):(console.log(`It was impossible to report success, ${callback_success} is not a function.`),console.log(`Success result: ${JSON.stringify(data)}`))}function notifyRetry(data){const callback_retry=document.querySelector(`${CHECKOUT_KLAP_ID}[${DATA_KLAP_FN_RETRY}]`).getAttribute(DATA_KLAP_FN_RETRY),callback_retry_function=eval(callback_retry);"function"==typeof callback_retry_function?callback_retry_function(data):(console.log(`It was impossible execute the retry function, ${callback_retry} is not a function.`),notifyError(data))}function isValidUrl(e){return/^(https?):\/\/[^\s$.?#].[^\s]*$/i.test(e)}function isBlank(e){return null==e||""===String(e)}function compareVersionJS(e,r){if(e===r)return 0;for(var o=e.split("."),t=r.split("."),n=Math.min(o.length,t.length),a=0;a<n;a++){if(parseInt(o[a])>parseInt(t[a]))return 1;if(parseInt(o[a])<parseInt(t[a]))return-1}return o.length>t.length?1:o.length<t.length?-1:0}loadConfig(config),void 0===window.jQuery||compareVersionJS(window.jQuery.fn.jquery,JQUERY_VERSION)<0?(klapConfig.prodMode||console.log("Adding jQuery version "+JQUERY_VERSION),addJQueryScript()):(klapConfig.prodMode||console.log("jQuery version "+window.jQuery.fn.jquery+" found."),scriptLoadHandler());const ERROR={E400001:{code:400001,message:"The order is not in pending status or the order is invalid."},E400002:{code:400002,message:"The cardNumber value is invalid."},E400003:{code:400003,message:"The cardExpiryDate value is invalid."},E400004:{code:400004,message:"The cardCvv value is invalid."},E400005:{code:400005,message:`The length of ${DATA_KLAP_CARD_NUMBER} is invalid.`},E400006:{code:400006,message:`The length of ${DATA_KLAP_EXPIRY_DATE} is invalid.`},E400007:{code:400007,message:`The length of ${DATA_KLAP_CARD_CVV} is invalid.`},E400008:{code:400008,message:"Invalid quota value."},E400009:{code:400009,message:"The card number is not valid. For now, only visa and mastercard are accepted."},E400010:{code:400010,message:"The rut value is invalid."},E400011:{code:400011,message:"The email value is invalid."},E400012:{code:400012,message:"The Sodexo cardType value is invalid."},E400013:{code:400013,message:"The dynamic code is invalid."},E400014:{code:400014,message:"The payment method is not supported yet."},E400901:{code:400901,message:"Invalid CardType value."},E404001:{code:404001,message:`Element with id ${CHECKOUT_KLAP_ID} not found.`},E404002:{code:404002,message:`Element ${CHECKOUT_KLAP_ID} with ${DATA_KLAP_FN_SUCCESS} attribute not found.`},E404003:{code:404003,message:`Element ${CHECKOUT_KLAP_ID} with ${DATA_KLAP_FN_ERROR} attribute not found or is blank.`},E404004:{code:404004,message:`Element ${CHECKOUT_KLAP_ID} with ${DATA_KLAP_ORDER_ID} attribute not found or is blank.`},E404005:{code:404005,message:`Element with ${DATA_KLAP_CARD_NUMBER} attribute not found inside ${CHECKOUT_KLAP_ID} element.`},E404006:{code:404006,message:`Element with ${DATA_KLAP_EXPIRY_DATE} attribute not found inside ${CHECKOUT_KLAP_ID} element.`},E404007:{code:404007,message:`Element with ${DATA_KLAP_CARD_CVV} attribute not found inside ${CHECKOUT_KLAP_ID} element.`},E404008:{code:404008,message:`Element with ${DATA_KLAP_SODEXO_RUT} attribute not found inside ${CHECKOUT_KLAP_ID} element.`},E404009:{code:404009,message:`Element with ${DATA_KLAP_SODEXO_EMAIL} attribute not found inside ${CHECKOUT_KLAP_ID} element.`},E404010:{code:404010,message:`Element with ${DATA_KLAP_SODEXO_CARD_TYPE} attribute not found inside ${CHECKOUT_KLAP_ID} element.`},E404011:{code:404011,message:`Element with ${DATA_KLAP_SODEXO_CODE} attribute not found inside ${CHECKOUT_KLAP_ID} element.`},E404901:{code:404901,message:`Element with ${DATA_KLAP_CARD_TYPE} attribute not found inside ${CHECKOUT_KLAP_ID} element.`},E404902:{code:404902,message:`Element with ${DATA_KLAP_QUOTAS} attribute not found inside ${CHECKOUT_KLAP_ID} element.`},E500001:{code:500001,message:"An error occurred while tokenizing the card."},E500002:{code:500002,message:"An error occurred while trying to run the payment."},E500003:{code:500003,message:"An error occurred while trying to pay in receipt step."},E500004:{code:500004,message:"An error occurred while trying to validate the payment authentication."},E500005:{code:500005,message:"An error occurred while trying to pay in validate payment authentication step."},E500006:{code:500006,message:"An error occurred while trying to pay a Sodexo order."}}};